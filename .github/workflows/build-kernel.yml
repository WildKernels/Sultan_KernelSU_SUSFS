name: Sultan Zuma Build

permissions:
  contents: read
  actions: read

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      # Optional: allow overriding kernel metadata when called as a reusable workflow
      codename:
        required: false
        type: string
        default: "zuma"
      repo:
        required: false
        type: string
        default: "android_kernel_google_zuma"
      android_version:
        required: false
        type: string
        default: "android14"
      kernel_version:
        required: false
        type: string
        default: "6.1"

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        # SUSFS on / off
        susfs: [false, true]

        # Different KernelSU variants
        build:
          # KernelSU-Next (KSUN)
          - type: KSUN
            ksu: true
            repo: "KernelSU-Next/KernelSU-Next"
            folder: "KernelSU-Next"
            branch: "next"
            exclude: susfs            # build only non-SUSFS variant
            susfs_repo: "pershoot/KernelSU-Next"
            susfs_branch: "next-susfs"
            kernel_patches: "james_patches/sultan/syscall_hooks.patch"
            extra_configs: "CONFIG_KSU_KPROBES_HOOK=n"
            ak3_suffix: "_KSUNext"

          # RKSU
          - type: RKSU
            ksu: true
            repo: "rsuntk/KernelSU"
            folder: "KernelSU"
            branch: "main"
            susfs_branch: "susfs-main"
            exclude: susfs            # non-SUSFS build only
            susfsless_kernel_patches: "james_patches/sultan/syscall_hooks.patch"
            extra_configs: "CONFIG_KSU_MANUAL_HOOK=y"
            ak3_suffix: "_RKSU"

          # SukiSU Ultra (SUSFS branch)
          - type: SukiSU
            ksu: true
            repo: "SukiSU-Ultra/SukiSU-Ultra"
            folder: "KernelSU"
            branch: "susfs-main"
            exclude: susfsless        # SUSFS build only
            kernel_patches: "suki_patches/hooks/scope_min_manual_hooks_v1.6.patch"
            extra_configs: "CONFIG_KSU_MANUAL_HOOK=y CONFIG_KSU_MANUAL_SU=n CONFIG_COMPAT=y CONFIG_ZRAM_GS_WRITEBACK=y"
            ak3_suffix: "_SukiSU"
            # kpm: "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux"

          # xxKSU (backslashxx)
          - type: xxKSU
            ksu: true
            exclude: susfs            # non-SUSFS build only
            repo: "backslashxx/KernelSU"
            folder: "KernelSU"
            branch: "master"
            ak3_suffix: "_xxKSU"

        # Only zuma kernel (Sultan base)
        kernel:
          - codename: ${{ inputs.codename || 'zuma' }}
            repo: ${{ inputs.repo || 'android_kernel_google_zuma' }}
            android_version: ${{ inputs.android_version || 'android14' }}
            kernel_version: ${{ inputs.kernel_version || '6.1' }}
            defconfig: zuma_defconfig
            # You can adjust these two to match the exact Sultan base you want:
            local_version: "-android14-11-gd7dac4b14270-ab12946699"
            build_date: "Sun Apr 20 04:20:00 UTC 2025"

        # Remove invalid combinations
        exclude:
          # Variants that say "exclude: susfs" should NOT build with susfs=true
          - build:
              exclude: susfs
            susfs: true
          # Variants that say "exclude: susfsless" should NOT build with susfs=false
          - build:
              exclude: susfsless
            susfs: false

    steps:
      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0 cross-compiler toolchain..."
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz -O gcc.tar.gz
          echo "Extracting .gz file..."
          gunzip gcc.tar.gz
          echo "Extracting .tar file..."
          tar -xf x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar
          echo "GCC 14.2.0 toolchain extracted successfully"

      - name: Clone dependencies and set environment
        run: |
          set -e

          ANYKERNEL_BRANCH="sultan-${{ matrix.kernel.codename }}"
          SUSFS_BRANCH="gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}"

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ccache lz4 zip

          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

          # AnyKernel3
          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          # SUSFS patches
          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" susfs
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV

          # WildKernels kernel patches (James)
          git clone --depth=1 https://github.com/WildKernels/kernel_patches.git james_patches
          echo "james_dir=$PWD/james_patches" >> $GITHUB_ENV

          # Sultan kernel source (kerneltoast)
          git clone --depth=1 https://github.com/kerneltoast/${{ matrix.kernel.repo }} sultan
          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV

          # SukiSU extra patches (for scope_min_manual_hooks)
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU_patch.git suki_patches
          echo "suki_dir=$PWD/suki_patches" >> $GITHUB_ENV

          # Custom changes (if you want to use them later)
          git clone --depth=1 https://gist.github.com/87371b65f283bb031d80e55b16b6d7ad.git my_changes
          echo "my_changes_dir=$PWD/my_changes" >> $GITHUB_ENV

          # Select KernelSU repo and branch (SUSFS vs normal)
          if [[ "${{ matrix.susfs }}" == "true" && -n "${{ matrix.build.susfs_repo }}" ]]; then
            echo "ksu_repo=${{ matrix.build.susfs_repo }}" >> $GITHUB_ENV
          else
            echo "ksu_repo=${{ matrix.build.repo }}" >> $GITHUB_ENV
          fi

          if [[ "${{ matrix.susfs }}" == "true" && -n "${{ matrix.build.susfs_branch }}" ]]; then
            echo "ksu_branch=${{ matrix.build.susfs_branch }}" >> $GITHUB_ENV
          else
            echo "ksu_branch=${{ matrix.build.branch }}" >> $GITHUB_ENV
          fi

          # Build name for artifact
          build_type="${{ matrix.build.ak3_suffix }}"
          if [[ "${{ matrix.susfs }}" == "true" ]]; then
            build_type="${build_type}.SUSFS"
          fi

          date=$(date +"%d.%m.%Y")
          zip_name="$date-${{ matrix.kernel.codename }}${build_type}_A16_Sultan-${{ github.run_number }}"
          echo "zip_name=$zip_name" >> $GITHUB_ENV

      - name: Setup kernel configuration and Mountify support
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          # Apply generic kernel patches for this variant (if any)
          if [[ -n "${{ matrix.build.kernel_patches }}" ]]; then
            for patch_name in ${{ matrix.build.kernel_patches }}; do
              echo "Applying kernel patch: $patch_name"
              patch -p1 -F 3 < "$GITHUB_WORKSPACE/$patch_name"
            done
          fi

          # Base configs: tmpfs / ACL / BBR / IPSet etc (mountify-style support + networking)
          configs="CONFIG_TMPFS_XATTR=y CONFIG_TMPFS_POSIX_ACL=y \
          CONFIG_IP_NF_TARGET_TTL=y CONFIG_IP6_NF_TARGET_HL=y CONFIG_IP6_NF_MATCH_HL=y \
          CONFIG_TCP_CONG_ADVANCED=y CONFIG_TCP_CONG_BBR=y CONFIG_NET_SCH_FQ=y \
          CONFIG_TCP_CONG_BIC=n CONFIG_TCP_CONG_WESTWOOD=n CONFIG_TCP_CONG_HTCP=n \
          CONFIG_DEFAULT_BBR=y CONFIG_BPF_STREAM_PARSER=y \
          CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y CONFIG_NETFILTER_XT_SET=y CONFIG_IP_SET=y \
          CONFIG_IP_SET_MAX=65534 CONFIG_IP_SET_BITMAP_IP=y CONFIG_IP_SET_BITMAP_IPMAC=y \
          CONFIG_IP_SET_BITMAP_PORT=y CONFIG_IP_SET_HASH_IP=y CONFIG_IP_SET_HASH_IPMARK=y \
          CONFIG_IP_SET_HASH_IPPORT=y CONFIG_IP_SET_HASH_IPPORTIP=y CONFIG_IP_SET_HASH_IPPORTNET=y \
          CONFIG_IP_SET_HASH_IPMAC=y CONFIG_IP_SET_HASH_MAC=y CONFIG_IP_SET_HASH_NETPORTNET=y \
          CONFIG_IP_SET_HASH_NET=y CONFIG_IP_SET_HASH_NETNET=y CONFIG_IP_SET_HASH_NETPORT=y \
          CONFIG_IP_SET_HASH_NETIFACE=y CONFIG_IP_SET_LIST_SET=y \
          CONFIG_IP6_NF_NAT=y CONFIG_IP6_NF_TARGET_MASQUERADE=y"

          # Extra configs from each variant
          if [[ -n "${{ matrix.build.extra_configs }}" ]]; then
            configs="$configs ${{ matrix.build.extra_configs }}"
          fi

          # Apply all configs to zuma defconfig
          for config in $configs; do
            echo "--> Adding ${config} <--"
            config_name=$(echo "${config}" | cut -d "=" -f 1)
            sed -i -E "s/.*(${config_name}=._*
