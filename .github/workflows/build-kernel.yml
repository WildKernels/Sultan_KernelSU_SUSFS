name: Sultan Zuma

permissions:
  contents: read
  actions: read

on:
  # Can be called from another workflow (e.g. a separate release orchestrator)
  workflow_call:
  # Manual trigger from the Actions tab
  workflow_dispatch:
  # Optional: CI on PR / push, only builds and uploads artifacts
  pull_request:
  push:
    paths-ignore:
      - "README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        susfs: [false, true]
        build:
          # Example: you can enable a non-KSU "Normal" build later if needed
          # - type: Normal
          #   ksu: false
          #   exclude: susfs
          #   ak3_suffix: ""

          - type: KSUN
            ksu: true
            repo: "KernelSU-Next/KernelSU-Next"
            folder: "KernelSU-Next"
            branch: "next"
            exclude: susfs
            susfs_repo: "pershoot/KernelSU-Next"
            susfs_branch: "next-susfs"
            ksu_patches: "KSUN/WildJames-Manager.patch"
            kernel_patches: "sultan/syscall_hooks.patch"
            extra_configs: "CONFIG_KSU_KPROBES_HOOK=n"
            ak3_suffix: "_KSUNext"

          - type: RKSU
            ksu: true
            repo: "rsuntk/KernelSU"
            folder: "KernelSU"
            branch: "main"
            susfs_branch: "susfs-main"
            exclude: susfs
            kernel_patches: ""
            susfsless_kernel_patches: "sultan/syscall_hooks.patch sultan/reboot-hook.patch"
            extra_configs: "CONFIG_KSU_MANUAL_HOOK=y"
            ak3_suffix: "_RKSU"

          - type: SukiSU
            ksu: true
            repo: "SukiSU-Ultra/SukiSU-Ultra"
            folder: "KernelSU"
            branch: "nongki"
            susfs_branch: "susfs-main"
            exclude: susfsless
            susfsless_kernel_patches: "sultan/syscall_hooks.patch sultan/reboot-hook.patch"
            extra_configs: "CONFIG_KSU_MANUAL_HOOK=y CONFIG_KSU_MANUAL_SU=n CONFIG_COMPAT=y CONFIG_ZRAM_GS_WRITEBACK=y"
            ak3_suffix: "_SukiSU"
            # kpm: "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux"

          - type: xxKSU
            ksu: true
            exclude: susfs
            repo: "backslashxx/KernelSU"
            folder: "KernelSU"
            branch: "master"
            kernel_patches: "sultan/scope-min-hooks-v1.6.patch"
            ak3_suffix: "_xxKSU"

        kernel:
          - codename: zuma
            repo: "android_kernel_google_zuma"
            android_version: "android14"
            kernel_version: "6.1"
            defconfig: zuma_defconfig
            local_version: "-android14-11-gd7dac4b14270-ab12946699"
            build_date: "Sun Apr 20 04:20:00 UTC 2025"

        exclude:
          # Any build that sets "exclude: susfs" will not be built for susfs=true
          - build:
              exclude: susfs
            susfs: true
          # Any build that sets "exclude: susfsless" will not be built for susfs=false
          - build:
              exclude: susfsless
            susfs: false

    steps:
      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0 cross-compiler toolchain..."
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz -O gcc.tar.gz
          echo "Extracting .gz file..."
          gunzip gcc.tar.gz
          echo "Extracting .tar file..."
          tar -xf gcc.tar
          TOOLCHAIN_DIR=$(tar -tf gcc.tar | head -1 | cut -d/ -f1)
          echo "TOOLCHAIN_DIR=$GITHUB_WORKSPACE/$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "Toolchain directory: $TOOLCHAIN_DIR"
          echo "GCC 14.2.0 toolchain extracted successfully"

      - name: Clone dependencies and set environment
        run: |
          ANYKERNEL_BRANCH="sultan-${{ matrix.kernel.codename }}"
          SUSFS_BRANCH="gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}"

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ccache git zip lz4 wget
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

          # AnyKernel3 preset per-device
          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          # SUSFS base patches
          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" susfs
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV

          # Patch collection (james_patches)
          git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git james_patches
          echo "james_dir=$PWD/james_patches" >> $GITHUB_ENV

          # Auto-upstream Sultan: always clone the latest from kerneltoast
          git clone --depth=1 https://github.com/kerneltoast/${{ matrix.kernel.repo }} sultan
          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV

          # Select KSU repo/branch; when susfs=true we can override with susfs_repo/susfs_branch
          ${{ matrix.susfs || false }} && ksu_repo="${{ matrix.build.susfs_repo || matrix.build.repo }}" || ksu_repo="${{ matrix.build.repo }}" || true
          echo "ksu_repo=$ksu_repo" >> $GITHUB_ENV
          ${{ matrix.susfs || false }} && ksu_branch="${{ matrix.build.susfs_branch || matrix.build.branch }}" || ksu_branch="${{ matrix.build.branch }}" || true
          echo "ksu_branch=$ksu_branch" >> $GITHUB_ENV

          build_type="${{ matrix.build.ak3_suffix }}"
          ${{ matrix.susfs }} && build_type="$build_type.SUSFS" || true
          date=$(date +"%Y.%m.%d")
          zip_name="$date-${{ matrix.kernel.codename }}${build_type}_A16_Sultan-${{ github.run_number }}"
          echo "zip_name=$zip_name" >> $GITHUB_ENV

      - name: Setup kernel base configs & Mountify support
        run: |
          cd "${{ env.kernel_dir }}"

          # General kernel patches (if defined in matrix)
          if [[ -n "${{ matrix.build.kernel_patches }}" ]]; then
            for patch_name in ${{ matrix.build.kernel_patches }}; do
              patch -p1 -F 3 < "${{ env.james_dir }}/${patch_name}"
            done
          fi

          # Base configs including Mountify, networking, IPSet and BBR
          configs="CONFIG_TMPFS_XATTR=y CONFIG_TMPFS_POSIX_ACL=y CONFIG_IP_NF_TARGET_TTL=y CONFIG_IP6_NF_TARGET_HL=y CONFIG_IP6_NF_MATCH_HL=y CONFIG_TCP_CONG_ADVANCED=y CONFIG_TCP_CONG_BBR=y CONFIG_NET_SCH_FQ=y CONFIG_TCP_CONG_BIC=n CONFIG_TCP_CONG_WESTWOOD=n CONFIG_TCP_CONG_HTCP=n CONFIG_DEFAULT_BBR=y CONFIG_BPF_STREAM_PARSER=y CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y CONFIG_NETFILTER_XT_SET=y CONFIG_IP_SET=y CONFIG_IP_SET_MAX=65534 CONFIG_IP_SET_BITMAP_IP=y CONFIG_IP_SET_BITMAP_IPMAC=y CONFIG_IP_SET_BITMAP_PORT=y CONFIG_IP_SET_HASH_IP=y CONFIG_IP_SET_HASH_IPMARK=y CONFIG_IP_SET_HASH_IPPORT=y CONFIG_IP_SET_HASH_IPPORTIP=y CONFIG_IP_SET_HASH_IPPORTNET=y CONFIG_IP_SET_HASH_IPMAC=y CONFIG_IP_SET_HASH_MAC=y CONFIG_IP_SET_HASH_NETPORTNET=y CONFIG_IP_SET_HASH_NET=y CONFIG_IP_SET_HASH_NETNET=y CONFIG_IP_SET_HASH_NETPORT=y CONFIG_IP_SET_HASH_NETIFACE=y CONFIG_IP_SET_LIST_SET=y CONFIG_IP6_NF_NAT=y CONFIG_IP6_NF_TARGET_MASQUERADE=y"
          if [[ -n "${{ matrix.build.extra_configs }}" ]]; then
            configs="$configs ${{ matrix.build.extra_configs }}"
          fi

          for config in $configs; do
            echo "--> Added ${config} <--"
            config_name=$(echo "${config}" | cut -d "=" -f 1)
            sed -i -E "s/.*(${config_name}=.*)/# \1/gi" arch/arm64/configs/${{ matrix.kernel.defconfig }}
            echo -e "\n${config}" >> arch/arm64/configs/${{ matrix.kernel.defconfig }}
          done

          # Match Sultan LOCALVERSION and build timestamp
          sed -i 's/${LOCALVERSION+set}/set/' scripts/setlocalversion
          if [[ -n "${{ matrix.kernel.local_version }}" ]]; then
            sed -i 's/CONFIG_LOCALVERSION="-Sultan"/CONFIG_LOCALVERSION="${{ matrix.kernel.local_version }}"/' arch/arm64/configs/${{ matrix.kernel.defconfig }}
          fi
          if [[ -n "${{ matrix.kernel.build_date }}" ]]; then
            perl -pi -e 's/build-timestamp = \$\(or \$\(KBUILD_BUILD_TIMESTAMP\), \$\(build-timestamp-auto\)\)/build-timestamp = "${{ matrix.kernel.build_date }}"/' init/Makefile
          fi

      - name: Add Baseband-guard
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ env.kernel_dir }}"
          echo "Adding Baseband-guard (BBG)..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          echo "CONFIG_BBG=y" >> "arch/arm64/configs/${{ matrix.kernel.defconfig }}"
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig

      - name: Add KernelSU variant (${{ matrix.build.type }})
        if: matrix.build.ksu
        run: |
          cd "${{ env.kernel_dir }}"

          echo "Adding KernelSU variant: ${{ matrix.build.type }} (repo: ${{ env.ksu_repo }}, branch: ${{ env.ksu_branch }})"
          curl -LSs "https://raw.githubusercontent.com/${{ env.ksu_repo }}/${{ env.ksu_branch }}/kernel/setup.sh" | bash -s ${{ env.ksu_branch }}
          if [[ -n "${{ matrix.build.checkout }}" ]]; then
            cd "${{ matrix.build.folder }}" && git checkout "${{ matrix.build.checkout }}" && cd -
          fi

          # Kernel patches used only when SUSFS is disabled (susfsless)
          if [[ -n "${{ matrix.build.susfsless_kernel_patches }}" && "${{ matrix.susfs }}" != "true" ]]; then
            for patch_name in ${{ matrix.build.susfsless_kernel_patches }}; do
              patch -p1 -F 3 < "${{ env.james_dir }}/${patch_name}"
            done
          fi

          # KSU patches used only when SUSFS is disabled (susfsless)
          if [[ -n "${{ matrix.build.susfsless_ksu_patches }}" && "${{ matrix.susfs }}" != "true" ]]; then
            cd "${{ matrix.build.folder }}"
            for patch_name in ${{ matrix.build.susfsless_ksu_patches }}; do
              patch -p1 < "${{ env.james_dir }}/${patch_name}"
            done
            cd "${{ env.kernel_dir }}"
          fi

          # General KSU patches (applied regardless of susfs)
          if [[ -n "${{ matrix.build.ksu_patches }}" ]]; then
            cd "${{ matrix.build.folder }}"
            for patch_name in ${{ matrix.build.ksu_patches }}; do
              patch -p1 < "${{ env.james_dir }}/${patch_name}"
            done
            cd "${{ env.kernel_dir }}"
          fi

          # Extra configs used only when SUSFS is disabled (susfsless)
          if [[ -n "${{ matrix.build.susfsless_configs }}" && "${{ matrix.susfs }}" != "true" ]]; then
            for config in ${{ matrix.build.susfsless_configs }}; do
              echo "--> Added ${config} <--"
              config_name=$(echo "${config}" | cut -d "=" -f 1)
              sed -i -E "s/.*(${config_name}=.*)/# \1/gi" arch/arm64/configs/${{ matrix.kernel.defconfig }}
              echo -e "\n${config}" >> arch/arm64/configs/${{ matrix.kernel.defconfig }}
            done
          fi

          # Base KSU config
          echo "CONFIG_KSU=y" >> arch/arm64/configs/${{ matrix.kernel.defconfig }}

      - name: Apply SUSFS patches
        if: matrix.susfs
        run: |
          cd "${{ env.kernel_dir }}"

          # Copy SUSFS patches into the kernel tree
          cp "${{ env.susfs_dir }}/kernel_patches/50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch" .
          cp "${{ env.susfs_dir }}/kernel_patches/fs/"* fs/
          cp "${{ env.susfs_dir }}/kernel_patches/include/linux/"* include/linux/

          # KSU patches specific for SUSFS (if set in matrix)
          if [[ -n "${{ matrix.build.susfs_ksu_patches }}" ]]; then
            cd "${{ env.kernel_dir }}/${{ matrix.build.folder }}"
            for patch_name in ${{ matrix.build.susfs_ksu_patches }}; do
              patch -p1 -F 3 < "${{ env.james_dir }}/${patch_name}"
            done
            cd "${{ env.kernel_dir }}"
          fi

          # Extra kernel patches for SUSFS (if any)
          if [[ -n "${{ matrix.build.susfs_kernel_patches }}" ]]; then
            for patch_name in ${{ matrix.build.susfs_kernel_patches }}; do
              patch -p1 -F 3 < "${{ env.james_dir }}/${patch_name}"
            done
          fi

          # Apply main SUSFS patch and sys.c fix
          patch -p1 < 50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch || true
          patch -p1 --fuzz=3 < "${{ env.james_dir }}/sultan/sys.c_fix.patch"

          # Additional SUSFS configs if defined in matrix
          if [[ -n "${{ matrix.build.susfs_configs }}" ]]; then
            for config in ${{ matrix.build.susfs_configs }}; do
              echo "--> Added ${config} <--"
              config_name=$(echo "${config}" | cut -d "=" -f 1)
              sed -i -E "s/.*(${config_name}=.*)/# \1/gi" arch/arm64/configs/${{ matrix.kernel.defconfig }}
              echo -e "\n${config}" >> arch/arm64/configs/${{ matrix.kernel.defconfig }}
            done
          fi

      - name: Cache kernel build
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ matrix.kernel.codename }}-${{ matrix.build.type }}-SUSFS_${{ matrix.susfs }}-ccache-${{ github.sha }}-${{ github.run_number }}
          restore-keys: |
            ${{ matrix.kernel.codename }}-${{ matrix.build.type }}-SUSFS_${{ matrix.susfs }}-ccache-
            ${{ matrix.kernel.codename }}-${{ matrix.build.type }}-
            ${{ matrix.kernel.codename }}-

      - name: Build the kernel
        run: |
          cd "${{ env.kernel_dir }}"

          export KBUILD_BUILD_USER="ctrlpaste"
          export KBUILD_BUILD_HOST="Github"

          make CROSS_COMPILE="${TOOLCHAIN_DIR}/bin/aarch64-linux-" CC="${TOOLCHAIN_DIR}/bin/aarch64-linux-gcc" -j"$(nproc --all)" ${{ matrix.kernel.defconfig }}
          make CROSS_COMPILE="ccache ${TOOLCHAIN_DIR}/bin/aarch64-linux-" CC="ccache ${TOOLCHAIN_DIR}/bin/aarch64-linux-gcc" -j"$(nproc --all)"

      - name: Setup AnyKernel3 zip and optional KPM
        run: |
          cd "${{ env.kernel_dir }}"

          echo "Copying Image.lz4 and concatenating DTB files..."
          cp ./out/arch/arm64/boot/Image.lz4 "${{ env.ak3_dir }}/Image.lz4"
          cat ./out/google-devices/${{ matrix.kernel.codename }}/dts/*.dtb > "${{ env.ak3_dir }}/dtb"

          if [[ -n "${{ matrix.build.kpm }}" ]]; then
            cd "${{ env.ak3_dir }}"
            curl -LSs "${{ matrix.build.kpm }}" -o patch && chmod 777 patch
            img_file=$(find . -maxdepth 1 -type f -name "Image*")
            echo "$img_file"

            if [[ "$img_file" == "./Image.gz"* ]]; then
              dd if="$img_file" bs=1 | gunzip > Image || true
              echo "-> Convert to: Image"
            elif [[ "$img_file" == "./Image.lz4" ]]; then
              lz4 -d "$img_file" Image
              echo "-> Decompress to: Image"
            fi

            ./patch && mv oImage Image

            if [[ "$img_file" == "./Image.gz"* ]]; then
              gzip -c Image > Image.gz
              rm Image
              echo "-> Compress: Image.gz"
              if [[ "$img_file" == "./Image.gz-dtb" ]]; then
                compressed_length=$(dd if=Image.gz-dtb bs=1 $skip | gzip -c | wc -c)
                dd if=Image.gz-dtb bs=1 skip=$compressed_length > dtb
                cat Image.gz dtb > Image.gz-dtb
                rm Image.gz dtb
                echo "-- Image.gz -> Image.gz-dtb"
              fi
            elif [[ "$img_file" == "./Image.lz4" ]]; then
              lz4 -f Image Image.lz4
              rm Image
              echo "-> Compress: Image.lz4"
            fi

            rm patch
            cd -
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.zip_name }}
          path: ${{ env.ak3_dir }}/*
