name: AOSP Zuma A16 KSU + SUSFS (no SukiSU)

permissions:
  contents: read
  actions: read

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: "Google zuma kernel branch"
        required: false
        default: "android-gs-akita-android16"
      android_version:
        description: "Android version string for SUSFS branch"
        required: false
        default: "android16"
      kernel_version:
        description: "Kernel version string for SUSFS branch"
        required: false
        default: "6.1"
      localversion:
        description: 'CONFIG_LOCALVERSION override (empty = keep stock)'
        required: false
        default: ""
      enable_baseband_guard:
        description: "Enable Baseband-guard integration"
        required: false
        default: "true"

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        build:
          # KSUN (KernelSU-Next) + SUSFS
          - type: KSUN
            ksu: true
            repo: "KernelSU-Next/KernelSU-Next"
            branch: "next"
            ak3_suffix: "_KSUNext"

          # RKSU (rsuntk) + SUSFS
          - type: RKSU
            ksu: true
            repo: "rsuntk/KernelSU"
            branch: "susfs-main"
            ak3_suffix: "_RKSU"

          # xxKSU (backslashxx) + SUSFS
          - type: xxKSU
            ksu: true
            repo: "backslashxx/KernelSU"
            branch: "master"
            ak3_suffix: "_xxKSU"

        kernel:
          - codename: "zuma"
            defconfig: "zuma_defconfig"

    env:
      KERNEL_REPO: "https://android.googlesource.com/kernel/devices/google/zuma"
      ANYKERNEL_REPO: "https://github.com/TheWildJames/AnyKernel3.git"
      ARCH: "arm64"

    steps:
      - name: Checkout this repo (for workflow context)
        uses: actions/checkout@v4

      # ------------------------------------------------------------------
      # Dependencies + ccache
      # ------------------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex git ccache \
            libssl-dev libncurses5-dev \
            build-essential wget zip \
            libelf-dev lz4

      - name: Setup ccache
        run: |
          ccache --max-size=5G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      # ------------------------------------------------------------------
      # Toolchain - GCC 14.2.0 nolibc (aarch64)
      # ------------------------------------------------------------------
      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/toolchain"
          cd "$GITHUB_WORKSPACE/toolchain"

          echo "Downloading GCC 14.2.0 cross-compiler..."
          wget -O toolchain.tar.gz \
            https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz

          echo "Extracting toolchain..."
          tar -xzf toolchain.tar.gz

          TOOLBIN="$GITHUB_WORKSPACE/toolchain/x86_64-gcc-14.2.0-nolibc/aarch64-linux/bin"

          if [ ! -x "$TOOLBIN/aarch64-linux-gcc" ]; then
            echo "ERROR: aarch64-linux-gcc not found in $TOOLBIN"
            ls -R "$GITHUB_WORKSPACE/toolchain"
            exit 1
          fi

          echo "CROSS_COMPILE=$TOOLBIN/aarch64-linux-" >> $GITHUB_ENV
          echo "CC=$TOOLBIN/aarch64-linux-gcc" >> $GITHUB_ENV

          echo "Toolchain files:"
          ls -R "$GITHUB_WORKSPACE/toolchain"

      # ------------------------------------------------------------------
      # Clone repos: AnyKernel3, SUSFS, James patches, AOSP zuma kernel
      # ------------------------------------------------------------------
      - name: Clone dependencies and set environment
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"

          CODENAME="${{ matrix.kernel.codename }}"
          DEFCONFIG="${{ matrix.kernel.defconfig }}"
          ANDROID_VERSION="${{ github.event.inputs.android_version }}"
          KERNEL_VERSION="${{ github.event.inputs.kernel_version }}"
          KBRANCH="${{ github.event.inputs.kernel_branch }}"
          [ -z "$KBRANCH" ] && KBRANCH="android-gs-akita-android16"

          SUSFS_BRANCH="gki-${ANDROID_VERSION}-${KERNEL_VERSION}"

          echo "Using:"
          echo "  codename       = $CODENAME"
          echo "  defconfig      = $DEFCONFIG"
          echo "  kernel branch  = $KBRANCH"
          echo "  SUSFS branch   = $SUSFS_BRANCH"

          # AnyKernel3: we reuse your Sultan zuma branch (good Pixel AK3 template)
          git clone --depth=1 "$ANYKERNEL_REPO" -b "sultan-${CODENAME}" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          # SUSFS patches
          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" susfs
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV

          # WildKernels patches (syscall_hooks + sys.c_fix)
          git clone --depth=1 https://github.com/WildKernels/kernel_patches.git james_patches
          echo "james_dir=$PWD/james_patches" >> $GITHUB_ENV

          # AOSP zuma kernel (Google)
          git clone "$KERNEL_REPO" kernel
          cd kernel
          git checkout "$KBRANCH"

          echo "kernel_dir=$PWD" >> $GITHUB_ENV
          echo "KERNEL_BRANCH=$KBRANCH" >> $GITHUB_ENV
          echo "ANDROID_VERSION=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          echo "CODENAME=$CODENAME" >> $GITHUB_ENV
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV

          echo "Kernel HEAD:"
          git log -1 --oneline

          # Name for output zip
          cd "$GITHUB_WORKSPACE"
          DATE="$(date +'%Y%m%d')"
          ZIP_NAME="${DATE}-${CODENAME}${{ matrix.build.ak3_suffix }}.SUSFS_A16_AOSP-${{ github.run_number }}"
          echo "zip_name=$ZIP_NAME" >> $GITHUB_ENV
          echo "Will produce: $ZIP_NAME.zip"

      # ------------------------------------------------------------------
      # Mountify-style configs
      # ------------------------------------------------------------------
      - name: Apply Mountify-related config options
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.DEFCONFIG }}"
          echo "Using defconfig: $DEFCONFIG_PATH"

          configs="\
          CONFIG_TMPFS_XATTR=y \
          CONFIG_TMPFS_POSIX_ACL=y \
          CONFIG_IP_NF_TARGET_TTL=y \
          CONFIG_IP6_NF_TARGET_HL=y \
          CONFIG_IP6_NF_MATCH_HL=y \
          CONFIG_TCP_CONG_ADVANCED=y \
          CONFIG_TCP_CONG_BBR=y \
          CONFIG_NET_SCH_FQ=y \
          CONFIG_TCP_CONG_BIC=n \
          CONFIG_TCP_CONG_WESTWOOD=n \
          CONFIG_TCP_CONG_HTCP=n \
          CONFIG_DEFAULT_BBR=y \
          CONFIG_BPF_STREAM_PARSER=y \
          CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y \
          CONFIG_NETFILTER_XT_SET=y \
          CONFIG_IP_SET=y \
          CONFIG_IP_SET_MAX=65534 \
          CONFIG_IP_SET_BITMAP_IP=y \
          CONFIG_IP_SET_BITMAP_IPMAC=y \
          CONFIG_IP_SET_BITMAP_PORT=y \
          CONFIG_IP_SET_HASH_IP=y \
          CONFIG_IP_SET_HASH_IPMARK=y \
          CONFIG_IP_SET_HASH_IPPORT=y \
          CONFIG_IP_SET_HASH_IPPORTIP=y \
          CONFIG_IP_SET_HASH_IPPORTNET=y \
          CONFIG_IP_SET_HASH_IPMAC=y \
          CONFIG_IP_SET_HASH_MAC=y \
          CONFIG_IP_SET_HASH_NETPORTNET=y \
          CONFIG_IP_SET_HASH_NET=y \
          CONFIG_IP_SET_HASH_NETNET=y \
          CONFIG_IP_SET_HASH_NETPORT=y \
          CONFIG_IP_SET_HASH_NETIFACE=y \
          CONFIG_IP_SET_LIST_SET=y \
          CONFIG_IP6_NF_NAT=y \
          CONFIG_IP6_NF_TARGET_MASQUERADE=y"

          for cfg in $configs; do
            name="$(echo "$cfg" | cut -d '=' -f1)"
            echo "Enabling $cfg in $DEFCONFIG_PATH"

            # Comment out any existing line for this config
            sed -i -E "s/.*($name=.*)/# \1/g" "$DEFCONFIG_PATH" || true
            printf "\n%s\n" "$cfg" >> "$DEFCONFIG_PATH"
          done

      # ------------------------------------------------------------------
      # Optional CONFIG_LOCALVERSION override
      # ------------------------------------------------------------------
      - name: Override CONFIG_LOCALVERSION (optional)
        if: github.event.inputs.localversion != ''
        run: |
          set -e
          cd "${{ env.kernel_dir }}"
          DEFCONFIG_PATH="arch/arm64/configs/${{ env.DEFCONFIG }}"
          LV="${{ github.event.inputs.localversion }}"

          echo "Overriding CONFIG_LOCALVERSION to: $LV"

          sed -i -E 's/CONFIG_LOCALVERSION="[^"]*"/# &/' "$DEFCONFIG_PATH" || true
          printf '\nCONFIG_LOCALVERSION="%s"\n' "$LV" >> "$DEFCONFIG_PATH"

      # ------------------------------------------------------------------
      # Baseband-guard (optional)
      # ------------------------------------------------------------------
      - name: Add Baseband-guard (BBG)
        if: github.event.inputs.enable_baseband_guard == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ env.kernel_dir }}"

          echo "Adding Baseband-guard..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.DEFCONFIG }}"
          echo 'CONFIG_BBG=y' >> "$DEFCONFIG_PATH"

          # Inject baseband_guard into LSM default list
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' \
            security/Kconfig

      # ------------------------------------------------------------------
      # KernelSU (KSUN / RKSU / xxKSU) + syscall_hooks
      # ------------------------------------------------------------------
      - name: Add KernelSU (${{ matrix.build.type }})
        if: matrix.build.ksu
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          echo "Integrating KernelSU variant: ${{ matrix.build.type }} (repo: ${{ matrix.build.repo }}, branch: ${{ matrix.build.branch }})"
          curl -LSs "https://raw.githubusercontent.com/${{ matrix.build.repo }}/${{ matrix.build.branch }}/kernel/setup.sh" | bash -s "${{ matrix.build.branch }}"

          # Apply syscall_hooks patch for KSUN and RKSU
          if [[ "${{ matrix.build.type }}" == "KSUN" || "${{ matrix.build.type }}" == "RKSU" ]]; then
            echo "Applying syscall_hooks patch from WildKernels..."
            patch -p1 -F 3 < "${{ env.james_dir }}/sultan/syscall_hooks.patch"
          else
            echo "xxKSU: no external syscall patch applied."
          fi

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.DEFCONFIG }}"

          # Basic KernelSU configs
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KSU_KPROBES_HOOK=n"
          } >> "$DEFCONFIG_PATH"

          # RKSU usually uses manual hook
          if [[ "${{ matrix.build.type }}" == "RKSU" ]]; then
            echo "CONFIG_KSU_MANUAL_HOOK=y" >> "$DEFCONFIG_PATH"
          fi

      # ------------------------------------------------------------------
      # SUSFS (all variants in this workflow use SUSFS)
      # ------------------------------------------------------------------
      - name: Apply SUSFS patches
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          KERNEL_VERSION="${{ env.KERNEL_VERSION }}"

          SRC="${{ env.susfs_dir }}/kernel_patches"
          PATCH_FILE="50_add_susfs_in_gki-${ANDROID_VERSION}-${KERNEL_VERSION}.patch"

          echo "Applying SUSFS with patch: $PATCH_FILE"

          cp "$SRC/$PATCH_FILE" ./
          cp "$SRC/fs/"* "./fs/"
          cp "$SRC/include/linux/"* "./include/linux/"

          patch -p1 < "$PATCH_FILE" || true

          echo "Applying sys.c_fix from WildKernels..."
          patch -p1 --fuzz=3 < "${{ env.james_dir }}/sultan/sys.c_fix.patch"

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.DEFCONFIG }}"

          {
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
            echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
            echo "CONFIG_KSU_SUSFS_SUS_SU=n"
          } >> "$DEFCONFIG_PATH"

      # ------------------------------------------------------------------
      # ccache cache
      # ------------------------------------------------------------------
      - name: Cache kernel build (ccache)
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: aosp-zuma-a16-${{ matrix.build.type }}-ccache-${{ github.sha }}
          restore-keys: |
            aosp-zuma-a16-${{ matrix.build.type }}-ccache-
            aosp-zuma-a16-ccache-

      # ------------------------------------------------------------------
      # Build
      # ------------------------------------------------------------------
      - name: Build kernel (defconfig + Image)
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          export ARCH=${{ env.ARCH }}
          export KBUILD_BUILD_USER="GitHub"
          export KBUILD_BUILD_HOST="Actions"

          echo "Using CROSS_COMPILE=$CROSS_COMPILE"
          echo "Using CC=$CC"

          mkdir -p out

          echo "=== Running defconfig: ${{ env.DEFCONFIG }} ==="
          make O=out ARCH=$ARCH \
            CROSS_COMPILE="$CROSS_COMPILE" \
            CC="$CC" \
            "${{ env.DEFCONFIG }}"

          echo "=== Building kernel with ccache ==="
          make O=out ARCH=$ARCH \
            CROSS_COMPILE="ccache $CROSS_COMPILE" \
            CC="ccache $CC" \
            -j"$(nproc --all)"

          ls -R out/arch/arm64/boot || true
          ls -R out/google-devices || true

      # ------------------------------------------------------------------
      # AnyKernel3 packaging
      # ------------------------------------------------------------------
      - name: Prepare AnyKernel3 files
        run: |
          set -e
          KDIR="${{ env.kernel_dir }}"
          AK3="${{ env.ak3_dir }}"
          CODENAME="${{ env.CODENAME }}"

          cd "$KDIR"

          IMG="out/arch/arm64/boot/Image.lz4"
          if [ ! -f "$IMG" ]; then
            echo "Image.lz4 not found at $IMG"
            exit 1
          fi

          DTB_DIR="out/google-devices/${CODENAME}/dts"
          if [ ! -d "$DTB_DIR" ]; then
            echo "DTB directory not found: $DTB_DIR"
            ls -R out/google-devices || true
            exit 1
          fi

          echo "Copying Image.lz4 and concatenating DTB into AnyKernel3..."
          cp "$IMG" "$AK3/Image.lz4"
          cat "$DTB_DIR"/*.dtb > "$AK3/dtb"

      - name: Create flashable zip
        run: |
          set -e
          cd "${{ env.ak3_dir }}"

          ZIP_NAME="${{ env.zip_name }}.zip"
          echo "Creating $ZIP_NAME..."
          zip -r "../$ZIP_NAME" ./*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.zip_name }}
          path: |
            ${{ github.workspace }}/**/*.zip
