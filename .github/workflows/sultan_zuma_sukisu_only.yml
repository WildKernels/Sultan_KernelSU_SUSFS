name: Sultan Zuma SukiSU only

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
  push:
    paths-ignore:
      - "README.md"

jobs:
  sukisu-build:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Toolchain
      # ------------------------------------------------------------
      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          set -e
          echo "Downloading GCC 14.2.0 cross-compiler toolchain..."
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz -O toolchain.tar.gz

          echo "Extracting toolchain..."
          mkdir -p toolchain_raw
          tar -xzf toolchain.tar.gz -C toolchain_raw

          echo "Searching for aarch64-linux-gcc* inside extracted toolchain..."
          GCC_CANDIDATE=$(find toolchain_raw -maxdepth 7 -type f -name 'aarch64-linux-gcc*' | head -n1 || true)

          if [ -z "$GCC_CANDIDATE" ]; then
            echo "ERROR: Could not find any aarch64-linux-gcc* binary inside toolchain_raw."
            find toolchain_raw -maxdepth 6 -type f | head -n 80 || true
            exit 1
          fi

          echo "Found GCC candidate: $GCC_CANDIDATE"

          TOOLCHAIN_BIN_DIR=$(cd "$(dirname "$GCC_CANDIDATE")" && pwd)
          echo "TOOLCHAIN_BIN_DIR=$TOOLCHAIN_BIN_DIR" >> $GITHUB_ENV

          echo "Toolchain bin dir:"
          ls -l "$TOOLCHAIN_BIN_DIR"

          GCC_BASENAME=$(basename "$GCC_CANDIDATE")
          if [ "$GCC_BASENAME" != "aarch64-linux-gcc" ]; then
            echo "Creating symlink aarch64-linux-gcc -> $GCC_BASENAME"
            ln -sf "$GCC_BASENAME" "$TOOLCHAIN_BIN_DIR/aarch64-linux-gcc"
          fi

      # ------------------------------------------------------------
      # Clone repos and environment
      # ------------------------------------------------------------
      - name: Clone dependencies and set environment
        run: |
          set -e

          CODENAME="zuma"
          ANDROID_VERSION="android14"
          KERNEL_VERSION="6.1"
          DEFCONFIG="zuma_defconfig"

          ANYKERNEL_BRANCH="sultan-${CODENAME}"

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ccache lz4 zip git wget

          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

          # AnyKernel3 (Sultan zuma branch)
          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          # Optional SukiSU patch repo (kept for future use)
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU_patch.git suki_patches
          echo "suki_dir=$PWD/suki_patches" >> $GITHUB_ENV

          # Sultan kernel source (kerneltoast)
          git clone --depth=1 https://github.com/kerneltoast/android_kernel_google_zuma sultan
          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV

          date=$(date +"%Y.%m.%d")
          zip_name="${date}-${CODENAME}_A16_Sultan-SukiSU-${GITHUB_RUN_NUMBER}"
          echo "zip_name=$zip_name" >> $GITHUB_ENV
          echo "codename=$CODENAME" >> $GITHUB_ENV
          echo "defconfig=$DEFCONFIG" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Mountify-style configs
      # ------------------------------------------------------------
      - name: Setup kernel config and Mountify support
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.defconfig }}"
          echo "Using defconfig: $DEFCONFIG_PATH"

          configs="CONFIG_TMPFS_XATTR=y CONFIG_TMPFS_POSIX_ACL=y \
          CONFIG_IP_NF_TARGET_TTL=y CONFIG_IP6_NF_TARGET_HL=y CONFIG_IP6_NF_MATCH_HL=y \
          CONFIG_TCP_CONG_ADVANCED=y CONFIG_TCP_CONG_BBR=y CONFIG_NET_SCH_FQ=y \
          CONFIG_TCP_CONG_BIC=n CONFIG_TCP_CONG_WESTWOOD=n CONFIG_TCP_CONG_HTCP=n \
          CONFIG_DEFAULT_BBR=y CONFIG_BPF_STREAM_PARSER=y \
          CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y CONFIG_NETFILTER_XT_SET=y CONFIG_IP_SET=y \
          CONFIG_IP_SET_MAX=65534 CONFIG_IP_SET_BITMAP_IP=y CONFIG_IP_SET_BITMAP_IPMAC=y \
          CONFIG_IP_SET_BITMAP_PORT=y CONFIG_IP_SET_HASH_IP=y CONFIG_IP_SET_HASH_IPMARK=y \
          CONFIG_IP_SET_HASH_IPPORT=y CONFIG_IP_SET_HASH_IPPORTIP=y CONFIG_IP_SET_HASH_IPPORTNET=y \
          CONFIG_IP_SET_HASH_IPMAC=y CONFIG_IP_SET_HASH_MAC=y CONFIG_IP_SET_HASH_NETPORTNET=y \
          CONFIG_IP_SET_HASH_NET=y CONFIG_IP_SET_HASH_NETNET=y CONFIG_IP_SET_HASH_NETPORT=y \
          CONFIG_IP_SET_HASH_NETIFACE=y CONFIG_IP_SET_LIST_SET=y \
          CONFIG_IP6_NF_NAT=y CONFIG_IP6_NF_TARGET_MASQUERADE=y"

          for config in $configs; do
            config_name=$(echo "${config}" | cut -d "=" -f 1)
            sed -i -E "s/.*(${config_name}=.*)/# \1/gi" "$DEFCONFIG_PATH" || true
            echo "${config}" >> "$DEFCONFIG_PATH"
          done

      # ------------------------------------------------------------
      # Baseband-guard
      # ------------------------------------------------------------
      - name: Add Baseband-guard (BBG)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ env.kernel_dir }}"
          echo "Adding Baseband-guard..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          echo "CONFIG_BBG=y" >> "arch/arm64/configs/${{ env.defconfig }}"
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig

      # ------------------------------------------------------------
      # KernelSU - SukiSU variant (no extra SUSFS patch here)
      # ------------------------------------------------------------
      - name: Add KernelSU (SukiSU)
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          echo "Integrating SukiSU from SukiSU-Ultra/SukiSU-Ultra (branch susfs-main)"
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh" | bash -s susfs-main

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.defconfig }}"

          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KSU_KPROBES_HOOK=n"
            echo "CONFIG_KSU_MANUAL_HOOK=y"
            echo "CONFIG_KSU_MANUAL_SU=n"
            echo "CONFIG_COMPAT=y"
            echo "CONFIG_ZRAM_GS_WRITEBACK=y"
          } >> "$DEFCONFIG_PATH"

      # ------------------------------------------------------------
      # ccache
      # ------------------------------------------------------------
      - name: Cache kernel build
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ env.codename }}-SukiSU-ccache-${{ github.sha }}
          restore-keys: |
            ${{ env.codename }}-SukiSU-ccache-
            ${{ env.codename }}-

      # ------------------------------------------------------------
      # Build
      # ------------------------------------------------------------
      - name: Build the kernel
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          export KBUILD_BUILD_USER="ctrlpaste"
          export KBUILD_BUILD_HOST="Github"

          TOOLCHAIN="${TOOLCHAIN_BIN_DIR}/aarch64-linux-"

          echo "Using defconfig: ${{ env.defconfig }}"
          make O=out CROSS_COMPILE="${TOOLCHAIN}" CC="${TOOLCHAIN}gcc" -j"$(nproc --all)" "${{ env.defconfig }}"

          echo "Starting kernel build..."
          make O=out CROSS_COMPILE="ccache ${TOOLCHAIN}" CC="ccache ${TOOLCHAIN}gcc" -j"$(nproc --all)"

          echo "Built files under:"
          ls -R out/arch/arm64/boot || true
          ls -R out/google-devices || true

      # ------------------------------------------------------------
      # AnyKernel3 packaging
      # ------------------------------------------------------------
      - name: Prepare AnyKernel3 files
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          echo "Copying Image.lz4 and DTB for zuma..."
          IMG="./out/arch/arm64/boot/Image.lz4"
          if [ ! -f "$IMG" ]; then
            echo "ERROR: Image.lz4 not found at $IMG"
            exit 1
          fi

          DTB_DIR="./out/google-devices/${{ env.codename }}/dts"
          if [ ! -d "$DTB_DIR" ]; then
            echo "ERROR: DTB directory not found: $DTB_DIR"
            ls -R ./out/google-devices || true
            exit 1
          fi

          cp "$IMG" "${{ env.ak3_dir }}/Image.lz4"
          cat "$DTB_DIR"/*.dtb > "${{ env.ak3_dir }}/dtb"

      - name: Create flashable zip
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"

          cd AK3
          ZIP_NAME="${{ env.zip_name }}.zip"
          echo "Creating AnyKernel3 zip: $ZIP_NAME"
          zip -r "../$ZIP_NAME" ./*
          cd ..

          echo "ARTIFACT_PATH=$PWD/$ZIP_NAME" >> $GITHUB_ENV
          echo "Artifact at: $PWD/$ZIP_NAME"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.zip_name }}
          path: ${{ env.ARTIFACT_PATH }}

  # ==================================================================
  # Release job - creates GitHub Release and attaches the SukiSU zip
  # ==================================================================
  release:
    needs: sukisu-build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: Generate tag name
        id: tagger
        run: |
          set -e
          DATE="$(date +'%Y.%m.%d')"
          BASE="SukiSU-${DATE}"

          echo "Base tag: $BASE"

          LAST_TAG=$(git tag --list "${BASE}-r*" | sort -V | tail -n1 || true)
          echo "Last tag for today: $LAST_TAG"

          if [ -z "$LAST_TAG" ]; then
            TAG="${BASE}-r1"
          else
            NUM=$(echo "$LAST_TAG" | sed -E 's/.*-r([0-9]+)$/\1/')
            NUM=$((NUM+1))
            TAG="${BASE}-r${NUM}"
          fi

          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"

      - name: Generate release body
        run: |
          cat << 'EOF' > release_body.md
Sultan Kernel (zuma) with SukiSU Ultra

- Base source: kerneltoast/android_kernel_google_zuma (Sultan)
- Variant: SukiSU only (no extra SUSFS patch from susfs4ksu)
- Includes:
  - KernelSU (SukiSU Ultra, manual hook)
  - Mountify-friendly TMPFS + IPSet + BBR networking configs
  - Baseband-guard (BBG) integrated

Notes:
- Make sure your device is on a compatible zuma / Android 14 build.
- Bootloader unlock is required for flashing custom kernels.
EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}
          body_path: release_body.md
          files: downloaded-artifacts/**/*

