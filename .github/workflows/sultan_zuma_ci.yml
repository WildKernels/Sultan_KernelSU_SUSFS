name: Sultan Zuma CI

permissions:
  contents: read
  actions: read

on:
  workflow_dispatch:
  push:
    paths-ignore:
      - "README.md"
  pull_request:
    paths-ignore:
      - "README.md"

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        build:
          - type: KSUN
            ksu: true
            repo: "KernelSU-Next/KernelSU-Next"
            branch: "next"
            ak3_suffix: "_KSUNext"

          - type: RKSU
            ksu: true
            repo: "rsuntk/KernelSU"
            branch: "susfs-main"
            ak3_suffix: "_RKSU"

          - type: xxKSU
            ksu: true
            repo: "backslashxx/KernelSU"
            branch: "master"
            ak3_suffix: "_xxKSU"

        kernel:
          - codename: "zuma"
            defconfig: "zuma_defconfig"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Install dependencies
      # ------------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache flex git \
            libssl-dev libelf-dev libncurses5-dev \
            lz4 wget zip

          ccache --max-size=5G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Cache toolchain
      # ------------------------------------------------------------
      - name: Cache GCC 14.2.0 toolchain
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: toolchain_raw
          key: gcc-14.2.0-aarch64-nolibc

      # ------------------------------------------------------------
      # Download & extract GCC (only if cache miss)
      # ------------------------------------------------------------
      - name: Download and setup GCC 14.2.0 toolchain
        run: |
          set -e
          if [ "${{ steps.cache-toolchain.outputs.cache-hit }}" != "true" ]; then
            echo "Toolchain cache miss, downloading..."
            rm -rf toolchain_raw
            mkdir -p toolchain_raw
            wget -O tc.tar.gz https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
            tar -xzf tc.tar.gz -C toolchain_raw
          else
            echo "Toolchain restored from cache."
          fi

          echo "Searching for aarch64-linux-gcc*..."
          GCC_CANDIDATE=$(find toolchain_raw -maxdepth 7 -type f -name 'aarch64-linux-gcc*' | head -n1 || true)
          if [ -z "$GCC_CANDIDATE" ]; then
            echo "ERROR: aarch64-linux-gcc not found inside toolchain_raw."
            find toolchain_raw -maxdepth 7 -type f | head -n 50 || true
            exit 1
          fi

          TOOLCHAIN_BIN_DIR=$(cd "$(dirname "$GCC_CANDIDATE")" && pwd)
          echo "TOOLCHAIN_BIN_DIR=$TOOLCHAIN_BIN_DIR" >> $GITHUB_ENV

          GCC_BASENAME=$(basename "$GCC_CANDIDATE")
          if [ "$GCC_BASENAME" != "aarch64-linux-gcc" ]; then
            ln -sf "$GCC_BASENAME" "$TOOLCHAIN_BIN_DIR/aarch64-linux-gcc"
          fi

          echo "Toolchain bin contents:"
          ls -l "$TOOLCHAIN_BIN_DIR"

      # ------------------------------------------------------------
      # Clone AK3, SUSFS, patches, Sultan kernel
      # ------------------------------------------------------------
      - name: Clone dependencies and Sultan kernel
        run: |
          set -e
          CODENAME="zuma"

          # AnyKernel3 (Sultan branch)
          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "sultan-$CODENAME" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          # SUSFS patches (android14 / 6.1)
          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "gki-android14-6.1" susfs
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV

          # WildKernels patches (sys.c_fix, syscall_hooks)
          git clone --depth=1 https://github.com/WildKernels/kernel_patches.git james_patches
          echo "james_dir=$PWD/james_patches" >> $GITHUB_ENV

          # Sultan kernel source
          git clone --depth=1 https://github.com/kerneltoast/android_kernel_google_zuma sultan
          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV

          echo "codename=$CODENAME" >> $GITHUB_ENV
          echo "defconfig=${{ matrix.kernel.defconfig }}" >> $GITHUB_ENV

          DATE=$(date +"%Y%m%d")
          ZIP_NAME="${DATE}-${CODENAME}${{ matrix.build.ak3_suffix }}-Sultan-SUSFS-${GITHUB_RUN_NUMBER}"
          echo "zip_name=$ZIP_NAME" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Mountify-style configs
      # ------------------------------------------------------------
      - name: Apply Mountify-related configs
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.defconfig }}"
          echo "Using defconfig: $DEFCONFIG_PATH"

          configs="\
          CONFIG_TMPFS_XATTR=y \
          CONFIG_TMPFS_POSIX_ACL=y \
          CONFIG_IP_NF_TARGET_TTL=y \
          CONFIG_IP6_NF_TARGET_HL=y \
          CONFIG_IP6_NF_MATCH_HL=y \
          CONFIG_TCP_CONG_ADVANCED=y \
          CONFIG_TCP_CONG_BBR=y \
          CONFIG_NET_SCH_FQ=y \
          CONFIG_TCP_CONG_BIC=n \
          CONFIG_TCP_CONG_WESTWOOD=n \
          CONFIG_TCP_CONG_HTCP=n \
          CONFIG_DEFAULT_BBR=y \
          CONFIG_BPF_STREAM_PARSER=y \
          CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y \
          CONFIG_NETFILTER_XT_SET=y \
          CONFIG_IP_SET=y \
          CONFIG_IP_SET_MAX=65534 \
          CONFIG_IP_SET_BITMAP_IP=y \
          CONFIG_IP_SET_BITMAP_IPMAC=y \
          CONFIG_IP_SET_BITMAP_PORT=y \
          CONFIG_IP_SET_HASH_IP=y \
          CONFIG_IP_SET_HASH_IPMARK=y \
          CONFIG_IP_SET_HASH_IPPORT=y \
          CONFIG_IP_SET_HASH_IPPORTIP=y \
          CONFIG_IP_SET_HASH_IPPORTNET=y \
          CONFIG_IP_SET_HASH_IPMAC=y \
          CONFIG_IP_SET_HASH_MAC=y \
          CONFIG_IP_SET_HASH_NETPORTNET=y \
          CONFIG_IP_SET_HASH_NET=y \
          CONFIG_IP_SET_HASH_NETNET=y \
          CONFIG_IP_SET_HASH_NETPORT=y \
          CONFIG_IP_SET_HASH_NETIFACE=y \
          CONFIG_IP_SET_LIST_SET=y \
          CONFIG_IP6_NF_NAT=y \
          CONFIG_IP6_NF_TARGET_MASQUERADE=y"

          for cfg in $configs; do
            name="$(echo "$cfg" | cut -d '=' -f1)"
            sed -i -E "s/.*($name=.*)/# \1/g" "$DEFCONFIG_PATH" || true
            printf "%s\n" "$cfg" >> "$DEFCONFIG_PATH"
          done

      # ------------------------------------------------------------
      # Baseband-guard
      # ------------------------------------------------------------
      - name: Add Baseband-guard
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          echo "Adding Baseband-guard..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.defconfig }}"
          echo "CONFIG_BBG=y" >> "$DEFCONFIG_PATH"

          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig

      # ------------------------------------------------------------
      # KernelSU (KSUN / RKSU / xxKSU) â€“ no SukiSU
      # ------------------------------------------------------------
      - name: Add KernelSU (${{ matrix.build.type }})
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          echo "Integrating KernelSU variant: ${{ matrix.build.type }} (repo: ${{ matrix.build.repo }}, branch: ${{ matrix.build.branch }})"
          curl -LSs "https://raw.githubusercontent.com/${{ matrix.build.repo }}/${{ matrix.build.branch }}/kernel/setup.sh" | bash -s "${{ matrix.build.branch }}"

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.defconfig }}"
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KSU_KPROBES_HOOK=n"
            echo "CONFIG_KSU_MANUAL_HOOK=y"
          } >> "$DEFCONFIG_PATH"

          if [[ "${{ matrix.build.type }}" != "xxKSU" ]]; then
            echo "Applying syscall_hooks.patch from WildKernels..."
            patch -p1 -F 3 < "${{ env.james_dir }}/sultan/syscall_hooks.patch"
          else
            echo "xxKSU: skipping external syscall_hooks patch."
          fi

      # ------------------------------------------------------------
      # SUSFS patches
      # ------------------------------------------------------------
      - name: Apply SUSFS patches
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          SRC="${{ env.susfs_dir }}/kernel_patches"
          PATCH_FILE="50_add_susfs_in_gki-android14-6.1.patch"

          echo "Applying SUSFS core patch: $PATCH_FILE"
          cp "$PATCH_FILE" .
          cp "$SRC/fs/"* ./fs/
          cp "$SRC/include/linux/"* ./include/linux/

          patch -p1 < "$PATCH_FILE" || true

          echo "Applying sys.c_fix from WildKernels..."
          patch -p1 --fuzz=3 < "${{ env.james_dir }}/sultan/sys.c_fix.patch"

          DEFCONFIG_PATH="arch/arm64/configs/${{ env.defconfig }}"
          {
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
            echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
            echo "CONFIG_KSU_SUSFS_SUS_SU=n"
          } >> "$DEFCONFIG_PATH"

      # ------------------------------------------------------------
      # Cache ccache
      # ------------------------------------------------------------
      - name: Cache kernel build (ccache)
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: zuma-sultan-${{ matrix.build.type }}-ccache-${{ github.ref_name }}
          restore-keys: |
            zuma-sultan-${{ matrix.build.type }}-ccache-
            zuma-sultan-

      # ------------------------------------------------------------
      # Build kernel
      # ------------------------------------------------------------
      - name: Build kernel
        run: |
          set -e
          cd "${{ env.kernel_dir }}"

          export ARCH=arm64
          export KBUILD_BUILD_USER="CI"
          export KBUILD_BUILD_HOST="GitHub-Actions"

          TC="${TOOLCHAIN_BIN_DIR}/aarch64-linux-"

          echo "Running defconfig: ${{ env.defconfig }}"
          make O=out ARCH=$ARCH CROSS_COMPILE="$TC" "${{ env.defconfig }}"

          echo "Building kernel with ccache..."
          make O=out ARCH=$ARCH CROSS_COMPILE="ccache $TC" -j"$(nproc)"

          echo "Output tree:"
          ls -R out/arch/arm64/boot || true
          ls -R out/google-devices || true

      # ------------------------------------------------------------
      # AnyKernel3 packaging
      # ------------------------------------------------------------
      - name: Package with AnyKernel3
        run: |
          set -e
          KDIR="${{ env.kernel_dir }}"
          AK3="${{ env.ak3_dir }}"
          CODENAME="${{ env.codename }}"

          IMG="$KDIR/out/arch/arm64/boot/Image.lz4"
          if [ ! -f "$IMG" ]; then
            echo "Image.lz4 not found at $IMG"
            exit 1
          fi

          DTB_DIR="$KDIR/out/google-devices/$CODENAME/dts"
          if [ ! -d "$DTB_DIR" ]; then
            echo "DTB dir not found: $DTB_DIR"
            ls -R "$KDIR/out/google-devices" || true
            exit 1
          fi

          cp "$IMG" "$AK3/Image.lz4"
          cat "$DTB_DIR"/*.dtb > "$AK3/dtb"

          cd "$AK3"
          OUT_ZIP="${{ env.zip_name }}${{ matrix.build.ak3_suffix }}.zip"
          echo "Creating zip: $OUT_ZIP"
          zip -r "../$OUT_ZIP" ./*

          echo "OUT_ZIP=$OUT_ZIP" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Upload artifact (for each variant)
      # ------------------------------------------------------------
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.zip_name }}${{ matrix.build.ak3_suffix }}
          path: "${{ github.workspace }}/*.zip"
