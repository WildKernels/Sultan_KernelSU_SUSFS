name: Sultan Zuma CI

permissions:
  contents: read
  actions: read

on:
  workflow_dispatch:
  push:
    paths-ignore:
      - "README.md"
  pull_request:
    paths-ignore:
      - "README.md"

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        build:
          - type: KSUN
            ksu: true
            repo: "KernelSU-Next/KernelSU-Next"
            branch: "next"
            ak3_suffix: "_KSUNext"

          - type: RKSU
            ksu: true
            repo: "rsuntk/KernelSU"
            branch: "susfs-main"
            ak3_suffix: "_RKSU"

          - type: xxKSU
            ksu: true
            repo: "backslashxx/KernelSU"
            branch: "master"
            ak3_suffix: "_xxKSU"

        kernel:
          - codename: "zuma"
            defconfig: "zuma_defconfig"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Install dependencies
      # ------------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache flex git \
            libssl-dev libelf-dev libncurses5-dev \
            lz4 wget zip

          ccache --max-size=5G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Cache toolchain
      # ------------------------------------------------------------
      - name: Cache GCC 14.2.0 toolchain
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: toolchain_raw
          key: gcc-14.2.0-aarch64-nolibc

      # ------------------------------------------------------------
      # Download & extract GCC (only if cache miss)
      # ------------------------------------------------------------
      - name: Download and setup GCC 14.2.0 toolchain
        run: |
          set -e
          if [ "${{ steps.cache-toolchain.outputs.cache-hit }}" != "true" ]; then
            echo "Toolchain cache miss, downloading..."
            rm -rf toolchain_raw
            mkdir -p toolchain_raw
            wget -O tc.tar.gz https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
            tar -xzf tc.tar.gz -C toolchain_raw
          else
            echo "Toolchain restored from cache."
          fi

          echo "Searching for aarch64-linux-gcc*..."
          GCC_CANDIDATE=$(find toolchain_raw -maxdepth 7 -type f -name 'aarch64-linux-gcc*' | head -n1 || true)
          if [ -z "$GCC_CANDIDATE" ]; then
            echo "ERROR: aarch64-linux-gcc not found inside toolchain_raw."
            find toolchain_raw -maxdepth 7 -type f | head -n 50 || true
            exit 1
          fi

          TOOLCHAIN_BIN_DIR=$(cd "$(dirname "$GCC_CANDIDATE")" && pwd)
          echo "TOOLCHAIN_BIN_DIR=$TOOLCHAIN_BIN_DIR" >> $GITHUB_ENV

          GCC_BASENAME=$(basename "$GCC_CANDIDATE")
          if [ "$GCC_BASENAME" != "aarch64-linux-gcc" ]; then
            ln -sf "$GCC_BASENAME" "$TOOLCHAIN_BIN_DIR/aarch64-linux-gcc"
          fi

          echo "Toolchain bin contents:"
          ls -l "$TOOLCHAIN_BIN_DIR"

      # ------------------------------------------------------------
      # Clone AK3, SUSFS, patches, Sultan kernel
      # ------------------------------------------------------------
      - name: Clone dependencies and Sultan kernel
        run: |
          set -e
          CODENAME="zuma"

          # AnyKernel3 (Sultan branch)
          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "sultan-$CODENAME" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          # SUSFS patches (android14 / 6.1)
          git clone --de
